<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Оплата — Hiddify VPN</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<section class="section">
  <h2>Оплата подписки Hiddify VPN</h2>

  <div class="pay-box">
    <h3>Наведите камерой на QR-код</h3>

    <!-- QR -->
    <img id="bank-qr" class="pay-qr" src="" alt="QR для оплаты">

    <!-- Link -->
    <a id="bank-link" class="btn-main" href="#" target="_blank">
      Перейти в Сбербанк для перевода
    </a>

    <!-- FORM -->
    <form id="contact-form" class="contact-box">
      <h4>
        После оплаты оставьте ваши контактные данные,
        чтобы мы отправили вам ключ доступа.
      </h4>

      <input name="firstname" placeholder="Имя *" required>
      <input name="lastname" placeholder="Фамилия *" required>

      <input
        name="sender_phone"
        placeholder="Номер телефона, с которого оплатили *"
        required
      >

      <input
        name="contact_phone"
        placeholder="Ваш номер для связи *"
        required
      >

      <input
        name="email"
        type="email"
        placeholder="Email (необязательно)"
      >

      <input
        name="messenger"
        placeholder="WhatsApp / Telegram / MAX (необязательно)"
      >

      <button type="submit" class="btn-main">
        Отправить данные
      </button>

      <p class="contact-note">
        Мы вышлем ключ после подтверждения оплаты.
      </p>
    </form>

  </div>
</section>

<script>
/* ===== QR ПО ОЧЕРЕДИ ===== */

const banks = [
  {
    qr: "img/pay1.png",
    link: "https://www.sberbank.com/sms/pbpn?requisiteNumber=79203794100"
  },
  {
    qr: "img/pay3.png",
    link: "https://www.sberbank.com/sms/pbpn?requisiteNumber=79298791010"
  }
];

let index = sessionStorage.getItem("payBankIndex");
index = index ? parseInt(index) : 0;

const bank = banks[index];

document.getElementById("bank-qr").src = bank.qr;
document.getElementById("bank-link").href = bank.link;

index = (index + 1) % banks.length;
sessionStorage.setItem("payBankIndex", index);


/* ===== ОТПРАВКА ФОРМЫ НА VPS BACKEND ===== */

document.getElementById("contact-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = new FormData(e.target);

  const payload = {
    name: formData.get("firstname"),
    surname: formData.get("lastname"),
    pay_phone: formData.get("sender_phone"),
    contact_phone: formData.get("contact_phone"),
    email: formData.get("email"),
    messenger: formData.get("messenger")
  };

  try {
    const res = await fetch("http://171.22.30.27:5000/send", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.status === "ok") {
      alert("Заявка отправлена! Мы скоро свяжемся с вами.");
      e.target.reset();
    } else {
      alert("Ошибка отправки: " + data.details);
    }

  } catch (err) {
    alert("Сервер недоступен. Попробуйте позже.");
  }
});
</script>

</body>
</html>
